<!-- /test -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Premie Movement Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/addons/p5.dom.min.js"></script>
    <script src="https://unpkg.com/p5ble@0.0.4/dist/p5.ble.js"></script>
    <link rel="stylesheet" href="styles.css">
  </head>

  <body>
    <div id="statusSquare">
      <p id = "status" style="color: red;">Disconnected</p>
    </div>
    <div id="title">
      <h1>Premature Infant Movement Tracker Dashboard</h1>
      <h3>Ensure the device is powered on and securely attached to infant, then click connect and select "MovementTracker" to begin data collection.</h3>
      <h4>Bluetooth connection can only be made in the Chrome browser.</h4>
    </div>

    <div id="buttons">
    </div>


    <div id="data">
      <button id="startUp">start</button>
      <button id="stopTime">end</button>
      <div id="time">
        <p> Time Since Start: </p>
        <p id = "timeSinceStart">--</p>
      </div>
      <div id="counter">
        <p>Number of Movements: </p>
        <p id="numberOfMovements">--</p>
      </div>
      <div id="magnitude">
        <p>Magnitude: </p>
        <p id="valueOfMagnitude">--</p>
      </div>
    </div>
    
    <div id="tableBox">
      <table id="tableData">
        <tr>
          <th>Number of Movements</th>
          <th>Time</th>
          <th>Magnitude of Movement</th>
        </tr>
      </table>
    </div>



    <script>

    //BLE References: https://itpnyu.github.io/p5ble-website/

    // The UUID of the service the arduino advertises that we connect to
    const serviceUuid = "2eabb710-354b-4066-95af-d8c1d4723e48";

    // Our BLE variables
    let movementCharacteristic;
    let magnitudeCharacteristic;
    let myBLE;

    // Global variables
    var startTime;
    var currentTime;
    var Interval;

    function setup() {
      // Create a p5ble class
      myBLE = new p5ble();

      // Connect button
      let connectButton = document.createElement("button");
      connectButton.setAttribute("id", "connectButtn");
      connectButton.innerHTML = "Connect";
      connectButton.setAttribute("onClick", "connectToBle()");
      document.getElementById("buttons").appendChild(connectButton);

      // Disconnect button
      let disconnectButton = document.createElement("button");
      disconnectButton.setAttribute("id", "disconnectButtn");
      disconnectButton.innerHTML = "Disconnect";
      disconnectButton.setAttribute("onClick", "disconnectToBle()");
      document.getElementById("buttons").appendChild(disconnectButton);

      // Start Button
      // Interval code referenced from: https://codepen.io/cathydutton/pen/xxpOOw?editors=1010
      var startButt = document.getElementById("startUp");
      var endButt = document.getElementById("stopTime");
      startButt.onclick = function() {
        populateTable("test1", "test2", "test3");
        clearInterval(Interval);
        startTime = Date.now();
        Interval = setInterval(testStartTime, 1);
        //setting interval will cause testStartTime to call every 1000 milliseconds
      }
      endButt.setAttribute("onClick", "testEndTime()");
    }



    function testStartTime() {
      //console.log("This should print every 10 milliseconds");
      var elapsedTime = Date.now() - startTime;
      var formatted = new Date(elapsedTime);
      formatted = formatted.toISOString().slice(11, 22);
      document.getElementById("timeSinceStart").innerHTML = formatted;
      //console.log(formatted);
    }

    function testEndTime() {
      console.log("ended the timer");
      clearInterval(Interval);
    }

    function connectToBle() {
      // Connect to a device by passing the service UUID
      myBLE.connect(serviceUuid, gotCharacteristics);
    }

    function disconnectToBle() {
      // Disonnect to the device
      myBLE.disconnect();
      // Check if myBLE is connected
      isConnected = myBLE.isConnected();
      document.getElementById("status").setAttribute("style", "color: red;");
      document.getElementById("status").innerHTML = "Disconnected";
      alert("Device has been disconnected.");
    }
    
    // A function that will be called once got characteristics
    function gotCharacteristics(error, characteristics) {
      if (error) console.log('error: ', error);
      console.log('characteristics: ', characteristics);
      magnitudeCharacteristic = characteristics[0];
      movementCharacteristic = characteristics[1];

      // Set datatype to 'custom', p5.ble.js won't parse the data, will return data as it is.
      myBLE.startNotifications(magnitudeCharacteristic, getMagnitude, 'int');
      myBLE.startNotifications(movementCharacteristic, getMovement, 'int');

      if (myBLE.isConnected()) {
        document.getElementById("status").setAttribute("style", "color: green;");
        document.getElementById("status").innerHTML = "Connected";
      }
    }

    // Function that will constantly get the value of movements
    function getMovement(value) {
      console.log('movement: ', value);
      document.getElementById("numberOfMovements").innerHTML = value;
    }

    // Function that will constantly get the value of the magnitude of the acceleration of the accelerometer
    function getMagnitude(value) {
      console.log('magnitude: ', value/100);
      document.getElementById("valueOfMagnitude").innerHTML = value/100;
    }

    function populateTable(movementNum, time, magValue) {
      console.log("populate the table called");

      //tr per row
      //td per entry
      var row = document.createElement("tr");
      var movementNumEntry = document.createElement("td");
      var timeEntry = document.createElement("td");
      var magValueEntry = document.createElement("td");

      movementNumEntry.innerHTML = movementNum;
      timeEntry.innerHTML = time;
      magValueEntry.innerHTML = magValue;

      row.appendChild(movementNumEntry);
      row.appendChild(timeEntry);
      row.appendChild(magValueEntry);

      document.getElementById("tableData").appendChild(row);
    }
  
    </script>
  </body>
</html>